import{u as E,aw as O,l as P,h as f,F as X,j as e,P as V,av as D,s as h,bA as Z,ay as ee,S as pe,bD as N,bC as ue,r as T,bM as H,az as fe,a_ as he,ae as z,aY as I,ap as F,cx as ye,c9 as G,ca as Q,K as be,cq as Re,cy as ge,cp as ve}from"./index.0cb2e516.js";import{u as ke}from"./index.esm.6af887f8.js";import{A as Ce}from"./AttributeForm.ba0220ea.js";import{V as te}from"./ViewHeader.2586557f.js";import{u as Y}from"./ConfirmDialog.f8013bbb.js";import{F as we}from"./FormAccess.bee4f1e0.js";import{K as Ae}from"./KeycloakTextInput.b4d5b2db.js";import{K as Ke}from"./KeycloakTextArea.f5e2440a.js";import{a as _,A as xe}from"./FormGroup.3d5f3f16.js";import{A as De,R as Ne}from"./AddRoleMappingModal.4adc845a.js";import{K as Te}from"./KeycloakTabs.3730c896.js";import{K as Ie,L as Fe}from"./KeycloakDataTable.4e517788.js";import{P as Se}from"./HelpItem.e440d5db.js";import{Q as Be}from"./question-circle-icon.c9ca7908.js";import{P as Ee}from"./PermissionTab.13062542.js";import{T as C,a as w}from"./Tabs.3d61d369.js";import"./KeyValueInput.cb1ae3e8.js";import"./FlexItem.308d9f82.js";import"./minus-circle-icon.de526f05.js";import"./plus-circle-icon.32cdf4dc.js";import"./Text.c38ffb52.js";import"./Modal.6593dfcc.js";import"./copy-icon.cf10e1f5.js";import"./GridItem.0db472b0.js";import"./useLocaleSort.84ea7ec0.js";import"./resource.df4d2bbd.js";import"./joinPath.69b856b1.js";import"./filter-icon.fec9f70e.js";import"./TableToolbar.c27bcd3c.js";import"./star-icon.97692015.js";import"./check.51c67984.js";import"./grip-vertical-icon.1b75ab8f.js";import"./Checkbox.2dc73ed3.js";import"./EmptyStateBody.a0363fe4.js";import"./EmptyStateSecondaryActions.1a804d56.js";import"./Trans.ec4d13b3.js";import"./Card.32e78d5f.js";import"./CardTitle.42e61ef4.js";import"./CardBody.a2e5e179.js";import"./plus-icon.407671b4.js";import"./MenuList.288a98b4.js";const J=({form:{handleSubmit:o,errors:n,register:l,getValues:g},save:y,editMode:c,reset:d})=>{const{t:a}=E("roles"),r=O(),{realm:p}=P();return f(X,{children:[!c&&e(te,{titleKey:a("createRole")}),e(V,{variant:"light",children:f(we,{isHorizontal:!0,onSubmit:o(y),role:"manage-realm",className:"pf-u-mt-lg",children:[e(_,{label:a("roleName"),fieldId:"kc-name",isRequired:!0,validated:n.name?"error":"default",helperTextInvalid:a("common:required"),children:e(Ae,{ref:l({required:!c,validate:s=>!!s.trim()||a("common:required").toString()}),type:"text",id:"kc-name",name:"name",isReadOnly:c})}),e(_,{label:a("common:description"),fieldId:"kc-description",validated:n.description?D.error:D.default,helperTextInvalid:n.description?.message,children:e(Ke,{name:"description","aria-label":"description",isDisabled:g().name?.includes("default-roles"),ref:l({maxLength:{value:255,message:a("common:maxLength",{length:255})}}),type:"text",validated:n.description?D.error:D.default,id:"kc-role-description"})}),f(xe,{children:[e(h,{variant:"primary",onClick:y,"data-testid":"realm-roles-save-button",children:a("common:save")}),e(h,{"data-testid":"cancel",onClick:()=>c?d():r(`/${p}/roles`),variant:"link",children:a(c?"common:revert":"common:cancel")})]})]})})]})},Oe=()=>{const o=O(),{realm:n}=P(),{t:l}=E("roles"),{id:g,clientId:y}=Z(),{adminClient:c}=ee(),d=async(r,p)=>{const s=await c.roles.findOneById({id:g});if(!s)throw new Error(l("common:notFound"));return s.clientRole?c.clients.findUsersWithRole({roleName:s.name,id:y,first:r,max:p}):c.roles.findUsersWithRole({name:s.name,first:r,max:p})},{enabled:a}=pe();return e(V,{"data-testid":"users-page",variant:"light",children:e(Ie,{isPaginated:!0,loader:d,ariaLabelKey:"roles:roleList",searchPlaceholderKey:"",toolbarItem:a&&e(Se,{"aria-label":"Basic popover",position:"bottom",bodyContent:f("div",{children:[l("roles:whoWillAppearPopoverText"),e(h,{className:"kc-groups-link",variant:"link",onClick:()=>o(`/${n}/groups`),children:l("common:groups")}),l("or"),f(h,{className:"kc-users-link",variant:"link",onClick:()=>o(`/${n}/users`),children:[l("users"),"."]})]}),footerContent:l("roles:whoWillAppearPopoverFooterText"),children:e(h,{variant:"link",className:"kc-who-will-appear-button",icon:e(Be,{}),children:l("roles:whoWillAppearLinkText")},"who-will-appear-button")}),emptyState:e(Fe,{hasIcon:!0,message:l("noDirectUsers"),instructions:f("div",{children:[l("noUsersEmptyStateDescription"),e(h,{className:"kc-groups-link-empty-state",variant:"link",onClick:()=>o(`/${n}/groups`),children:l("common:groups")}),l("or"),e(h,{className:"kc-users-link-empty-state",variant:"link",onClick:()=>o(`/${n}/users`),children:l("users")}),l("noUsersEmptyStateDescriptionContinued")]})}),columns:[{name:"username",displayKey:"roles:userName",cellFormatters:[N()]},{name:"email",displayKey:"roles:email",cellFormatters:[N()]},{name:"lastName",displayKey:"roles:lastName",cellFormatters:[N()]},{name:"firstName",displayKey:"roles:firstName",cellFormatters:[ue(),N()]}]})})};function wt(){const{t:o}=E("roles"),n=ke({mode:"onChange"}),{setValue:l,getValues:g,trigger:y,reset:c}=n,d=O(),{adminClient:a}=ee(),[r,p]=T.exports.useState(),{id:s,clientId:u}=Z(),{url:b}=H(),{realm:oe}=P(),[L,ae]=T.exports.useState(0),M=()=>{ae(L+1)},{addAlert:A,addError:K}=fe(),[U,$]=T.exports.useState(!1),S=t=>{const{attributes:i,...R}=t;return{attributes:ve(i),...R}},[v,re]=T.exports.useState();he(async()=>{const t=await a.realms.findOne({realm:oe});if(!s)return{realm:t};const i=await a.roles.findOneById({id:s});return{realm:t,role:i}},({realm:t,role:i})=>{if(!t||!i&&s)throw new Error(o("common:notFound"));if(re(t),i){const R=S(i);p(R),Object.entries(R).map(m=>{l(m[0],m[1])})}},[L,b]);const B=async()=>{try{const t=g();if(t.attributes&&t.attributes[t.attributes.length-1]?.key===""&&l("attributes",t.attributes.slice(0,t.attributes.length-1)),!await y())return;const{attributes:i,...R}=t;let m=R;if(m.name=m.name?.trim(),s)i&&(m.attributes=Re(i)),m={...ge(r,"attributes"),...m},u?await a.clients.updateRole({id:u,roleName:t.name},m):await a.roles.updateById({id:s},m),p(S(m));else{let k;if(u?(await a.clients.createRole({id:u,name:t.name}),t.description&&await a.clients.updateRole({id:u,roleName:t.name},m),k=await a.clients.findRole({id:u,roleName:t.name})):(await a.roles.create(m),k=await a.roles.findOneByName({name:t.name})),!k)throw new Error(o("common:notFound"));p(S(k)),d(b.substr(0,b.lastIndexOf("/")+1)+k.id+"/details")}A(o(s?"roleSaveSuccess":"roleCreated"),I.success)}catch(t){K(`roles:${s?"roleSave":"roleCreate"}Error`,t)}},[q,se]=Y({titleKey:"roles:roleDeleteConfirm",messageKey:o("roles:roleDeleteConfirmDialog",{selectedRoleName:r?.name||o("createRole")}),continueButtonLabel:"common:delete",continueButtonVariant:z.danger,onConfirm:async()=>{try{u?await a.clients.delRole({id:u,roleName:r.name}):await a.roles.delById({id:s}),A(o("roleDeletedSuccess"),I.success),d(b.substr(0,b.indexOf("/roles")+6))}catch(t){K("roles:roleDeleteError",t)}}}),le=b.includes("associated-roles")?[e(F,{component:"button",onClick:()=>ie(),children:o("roles:removeAllAssociatedRoles")},"delete-all-associated"),e(F,{component:"button",onClick:()=>{q()},children:o("deleteRole")},"delete-role")]:[e(F,{"data-testid":"add-roles",component:"button",onClick:()=>ce(),children:o("addAssociatedRolesText")},"toggle-modal"),e(F,{component:"button",onClick:()=>q(),children:o("deleteRole")},"delete-role")],[ie,ne]=Y({titleKey:o("roles:removeAllAssociatedRoles")+"?",messageKey:o("roles:removeAllAssociatedRolesConfirmDialog",{name:r?.name||o("createRole")}),continueButtonLabel:"common:delete",continueButtonVariant:z.danger,onConfirm:async()=>{try{const t=await a.roles.getCompositeRoles({id:r.id});await a.roles.delCompositeRoles({id:s},t),A(o("compositeRoleOff"),I.success,o("compositesRemovedAlertDescription")),me(),M()}catch(t){K("roles:roleDeleteError",t)}}}),ce=()=>{$(!U)},x=H(ye.path),me=()=>{const t=x?G({...x.params,tab:"details"}):Q({realm:v?.realm,id:s,tab:"details"});d(t)},de=()=>{const t=x?G({...x.params,tab:"associated-roles"}):Q({realm:v?.realm,id:s,tab:"associated-roles"});d(t)},W=async t=>{try{await a.roles.createComposite({roleId:r?.id,realm:v.realm},t),M(),de(),A(o("addAssociatedRolesSuccess"),I.success)}catch(i){K("roles:addAssociatedRolesError",i)}},j=t=>v?.defaultRole.name===t;return v?r?f(X,{children:[e(se,{}),e(ne,{}),U&&e(De,{id:s,type:"roles",name:r.name,onAssign:t=>W(t.map(i=>i.role)),onClose:()=>$(!1)}),e(te,{titleKey:r.name||o("createRole"),badges:[{id:"composite-role-badge",text:r.composite?o("composite"):"",readonly:!0}],subKey:s?"":"roles:roleCreateExplain",actionsDropdownId:"roles-actions-dropdown",dropdownItems:le,divider:!s}),e(V,{variant:"light",className:"pf-u-p-0",children:s&&f(Te,{isBox:!0,mountOnEnter:!0,children:[e(C,{eventKey:"details",title:e(w,{children:o("common:details")}),children:e(J,{reset:()=>c(r),form:n,save:B,editMode:!0})}),r.composite&&e(C,{eventKey:"associated-roles",className:"kc-associated-roles-tab",title:e(w,{children:o("associatedRolesText")}),children:e(Ne,{name:r.name,id:r.id,type:"roles",isManager:!0,save:t=>W(t.map(i=>i.role))})}),!j(r.name)&&e(C,{eventKey:"attributes",className:"kc-attributes-tab",title:e(w,{children:o("common:attributes")}),children:e(Ce,{form:n,save:B,reset:()=>c(r)})}),!j(r.name)&&e(C,{eventKey:"users-in-role",title:e(w,{children:o("usersInRole")}),children:e(Oe,{"data-cy":"users-in-role-tab"})}),e(C,{eventKey:"permissions",title:e(w,{children:o("common:permissions")}),children:e(Ee,{id:r.id,type:"roles"})})]})})]}):e(J,{reset:()=>c(r),form:n,save:B,editMode:!1}):e(be,{})}export{wt as default};
