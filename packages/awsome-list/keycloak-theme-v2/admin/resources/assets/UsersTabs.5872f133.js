import{bd as Qe,be as mt,bf as pt,bi as je,bh as ft,bg as ht,d as bt,bj as He,c as gt,ak as yt,i as It,cZ as vt,c_ as wt,c$ as Ct,d0 as kt,d1 as xt,d2 as St,u as q,l as De,r as f,aw as Xe,ay as W,az as te,aD as Me,a_ as Re,h as k,j as e,F as J,cA as Tt,aA as Ee,ag as At,s as K,aY as O,S as Pt,ae as fe,bD as Z,b8 as Ze,bA as Se,av as V,g as Lt,P as be,T as Ae,bC as Dt,b4 as Rt,cs as Ft,L as _e,co as et,cp as Gt,cq as Nt,d3 as Et,d4 as Ut,an as Kt,aq as Mt,am as Bt,ap as Ue,H as Ot,o as ze,d5 as qt,K as Vt,bW as jt}from"./index.0cb2e516.js";import{a as Be,C as ge,u as Ce,b as Ht,F as tt}from"./index.esm.6af887f8.js";import{V as _t}from"./ViewHeader.2586557f.js";import{F as zt}from"./FormAccess.bee4f1e0.js";import{H as pe,P as $t}from"./HelpItem.e440d5db.js";import{K as de}from"./KeycloakTextInput.b4d5b2db.js";import{u as rt}from"./useFormatDate.53169b6c.js";import{G as st,a as Wt}from"./GroupPickerDialog.f5430678.js";import{a as U,A as Yt,F as Fe}from"./FormGroup.3d5f3f16.js";import{S as at,a as nt,C as it,c as ot,b as Jt}from"./Select.5a6b39aa.js";import{K as Qt}from"./KeycloakTabs.3730c896.js";import{u as ye,C as dt}from"./ConfirmDialog.f8013bbb.js";import{K as Le,L as Oe,a as Xt,T as Zt,n as er,o as tr}from"./KeycloakDataTable.4e517788.js";import{i as rr,ah as $,M as sr,f as ee,a as ar,b as nr,c as Ge,d as he,e as ir,A as Ne}from"./TableToolbar.c27bcd3c.js";import{C as or}from"./Checkbox.2dc73ed3.js";import{Q as dr}from"./question-circle-icon.c9ca7908.js";import{C as lr,S as cr}from"./SessionsTable.1482375a.js";import{F as $e}from"./FormPanel.4ba67868.js";import{c as xe}from"./capitalize.388ec7cb.js";import{M as lt,a as qe}from"./Modal.6593dfcc.js";import{T as Pe}from"./Text.c38ffb52.js";import{R as ur}from"./AddRoleMappingModal.4adc845a.js";import{A as mr}from"./AttributeForm.ba0220ea.js";import{P as We}from"./PasswordInput.34ff6dd3.js";import{u as Ke}from"./useToggle.8c992bea.js";import{T as pr}from"./TimeSelector.1a65a2e3.js";import{u as fr}from"./useLocaleSort.84ea7ec0.js";import{T as ue,a as me}from"./Tabs.3d61d369.js";import"./copy-icon.cf10e1f5.js";import"./GridItem.0db472b0.js";import"./DataListItemRow.8f458244.js";import"./data-list.f7ff2ea7.js";import"./grip-vertical-icon.1b75ab8f.js";import"./check.51c67984.js";import"./star-icon.97692015.js";import"./plus-circle-icon.32cdf4dc.js";import"./EmptyStateBody.a0363fe4.js";import"./EmptyStateSecondaryActions.1a804d56.js";import"./ListItem.f69883ba.js";import"./CardHeader.f162738f.js";import"./Card.32e78d5f.js";import"./CardTitle.42e61ef4.js";import"./CardBody.a2e5e179.js";import"./resource.df4d2bbd.js";import"./joinPath.69b856b1.js";import"./filter-icon.fec9f70e.js";import"./KeyValueInput.cb1ae3e8.js";import"./FlexItem.308d9f82.js";import"./minus-circle-icon.de526f05.js";import"./plus-icon.407671b4.js";import"./MenuList.288a98b4.js";var hr=Math.min;function br(t,r,i){for(var c=i?ft:ht,l=t[0].length,a=t.length,u=a,m=Array(a),d=1/0,n=[];u--;){var p=t[u];u&&r&&(p=Qe(p,mt(r))),d=hr(p.length,d),m[u]=!i&&(r||l>=120&&p.length>=120)?new pt(u&&p):void 0}p=t[0];var o=-1,g=m[0];e:for(;++o<l&&n.length<d;){var y=p[o],I=r?r(y):y;if(y=i||y!==0?y:0,!(g?je(g,I):c(n,I,i))){for(u=a;--u;){var G=m[u];if(!(G?je(G,I):c(t[u],I,i)))continue e}g&&g.push(I),n.push(y)}}return n}function gr(t){return rr(t)?t:[]}var yr=bt(function(t){var r=He(t),i=Qe(t,gr);return r===He(i)?r=void 0:i.pop(),i.length&&i[0]===t[0]?br(i,gt(r)):[]});const Ir=yr;var vr="[object Map]",wr="[object Set]",Cr=Object.prototype,kr=Cr.hasOwnProperty;function Ye(t){if(t==null)return!0;if(yt(t)&&(It(t)||typeof t=="string"||typeof t.splice=="function"||vt(t)||wt(t)||Ct(t)))return!t.length;var r=kt(t);if(r==vr||r==wr)return!t.size;if(xt(t))return!St(t).length;for(var i in t)if(kr.call(t,i))return!1;return!0}const Je=({user:t,bruteForce:{isBruteForceProtected:r,isLocked:i}={isBruteForceProtected:!1,isLocked:!1},save:c,onGroupsUpdate:l})=>{const{t:a}=q("users"),{realm:u}=De(),m=rt(),[d,n]=f.exports.useState(!1),p=Xe(),{adminClient:o}=W(),{addAlert:g,addError:y}=te(),{hasAccess:I}=Me(),G=I("manage-users"),{handleSubmit:S,register:N,watch:re,control:H,reset:R,formState:{errors:E}}=Be(),F=re("username"),[L,M]=f.exports.useState([]),[h,b]=f.exports.useState(!1),[T,_]=f.exports.useState(i),[ae,ke]=f.exports.useState(),[C,z]=f.exports.useState([]);Re(()=>Promise.all([o.realms.findOne({realm:u}),o.authenticationManagement.getRequiredActions()]),([v,B])=>{if(!v)throw new Error(a("common:notFound"));ke(v),z(B)},[]);const ne=async()=>{try{await o.attackDetection.del({id:t.id}),g(a("unlockSuccess"),O.success)}catch(v){y("users:unlockError",v)}},le=()=>{n(!1)},ce=v=>{M(L.filter(B=>B.name!==v)),l(L)},Ie=async v=>{M([...L,...v]),l([...L,...v])},ve=async v=>{v.forEach(async Y=>{try{await o.users.addToGroup({id:t.id,groupId:Y.id}),g(a("users:addedGroupMembership"),O.success)}catch(ie){y("users:addedGroupMembershipError",ie)}})},we=()=>{b(!h)};return k(zt,{isHorizontal:!0,onSubmit:S(c),role:"query-users",fineGrainedAccess:t?.access?.manage,className:"pf-u-mt-lg",children:[h&&e(st,{type:"selectMany",text:{title:"users:selectGroups",ok:"users:join"},canBrowse:G,onConfirm:v=>{t?.id?ve(v||[]):Ie(v||[]),b(!1)},onClose:()=>b(!1),filterGroups:L.map(v=>v.name)}),t?.id&&k(J,{children:[e(U,{label:a("common:id"),fieldId:"kc-id",isRequired:!0,children:e(de,{id:t.id,"aria-label":a("userID"),value:t.id,type:"text",isReadOnly:!0})}),e(U,{label:a("createdAt"),fieldId:"kc-created-at",isRequired:!0,children:e(de,{value:m(new Date(t.createdTimestamp)),type:"text",id:"kc-created-at","aria-label":a("createdAt"),name:"createdTimestamp",isReadOnly:!0})})]}),!ae?.registrationEmailAsUsername&&e(U,{label:a("username"),fieldId:"kc-username",isRequired:!0,validated:E.username?"error":"default",helperTextInvalid:a("common:required"),children:e(de,{ref:N(),type:"text",id:"kc-username","aria-label":a("username"),name:"username",isReadOnly:!!t?.id&&!ae?.editUsernameAllowed&&ae?.editUsernameAllowed!==void 0})}),e(U,{label:a("email"),fieldId:"kc-description",validated:E.email?"error":"default",helperTextInvalid:a("users:emailInvalid"),children:e(de,{ref:N({pattern:Tt}),type:"email",id:"kc-email",name:"email","data-testid":"email-input","aria-label":a("emailInput")})}),e(U,{label:a("emailVerified"),fieldId:"kc-email-verified",helperTextInvalid:a("common:required"),labelIcon:e(pe,{helpText:"users-help:emailVerified",fieldLabelId:"users:emailVerified"}),children:e(ge,{name:"emailVerified",defaultValue:!1,control:H,render:({onChange:v,value:B})=>e(Ee,{"data-testid":"email-verified-switch",id:"kc-user-email-verified",isDisabled:!1,onChange:Y=>v(Y),isChecked:B,label:a("common:on"),labelOff:a("common:off"),"aria-label":a("emailVerified")})})}),e(U,{label:a("firstName"),fieldId:"kc-firstname",validated:E.firstName?"error":"default",helperTextInvalid:a("common:required"),children:e(de,{ref:N(),"data-testid":"firstName-input",type:"text",id:"kc-firstname","aria-label":a("firstName"),name:"firstName"})}),e(U,{label:a("lastName"),fieldId:"kc-name",validated:E.lastName?"error":"default",children:e(de,{ref:N(),"data-testid":"lastName-input",type:"text",id:"kc-lastname",name:"lastName","aria-label":a("lastName")})}),r&&e(U,{label:a("temporaryLocked"),fieldId:"temporaryLocked",labelIcon:e(pe,{helpText:"users-help:temporaryLocked",fieldLabelId:"users:temporaryLocked"}),children:e(Ee,{"data-testid":"user-locked-switch",id:"temporaryLocked",onChange:v=>{ne(),_(v)},isChecked:T,isDisabled:!T,label:a("common:on"),labelOff:a("common:off"),"aria-label":a("temporaryLocked")})}),e(U,{label:a("requiredUserActions"),fieldId:"kc-required-user-actions",validated:E.requiredActions?"error":"default",helperTextInvalid:a("common:required"),labelIcon:e(pe,{helpText:"users-help:requiredUserActions",fieldLabelId:"users:requiredUserActions"}),children:e(ge,{name:"requiredActions",defaultValue:[],typeAheadAriaLabel:"Select an action",control:H,render:({onChange:v,value:B})=>e(at,{"data-testid":"required-actions-select",placeholderText:"Select action",toggleId:"kc-required-user-actions",onToggle:()=>n(!d),isOpen:d,selections:B,onSelect:(Y,ie)=>{const s=ie;B.includes(s)?v(B.filter(w=>w!==s)):v([...B,s])},onClear:le,variant:"typeaheadmulti",children:C.map(({alias:Y,name:ie})=>e(nt,{value:Y,children:ie},Y))})})}),!t?.id&&e(U,{label:a("common:groups"),fieldId:"kc-groups",validated:E.requiredActions?"error":"default",helperTextInvalid:a("common:required"),labelIcon:e(pe,{helpText:"users-help:groups",fieldLabelId:"groups"}),children:e(ge,{name:"groups",defaultValue:[],typeAheadAriaLabel:"Select an action",control:H,render:()=>k(At,{children:[e(it,{categoryName:" ",children:L.map(v=>e(ot,{onClick:()=>ce(v.name),children:v.path},v.id))}),e(K,{id:"kc-join-groups-button",onClick:we,variant:"secondary","data-testid":"join-groups-button",children:a("users:joinGroups")})]})})}),k(Yt,{children:[e(K,{"data-testid":t?.id?"save-user":"create-user",isDisabled:!t?.id&&!F&&!ae?.registrationEmailAsUsername,variant:"primary",type:"submit",children:t?.id?a("common:save"):a("common:create")}),e(K,{"data-testid":"cancel-create-user",onClick:()=>t?.id?R(t):p(`/${u}/users`),variant:"link",children:t?.id?a("common:revert"):a("common:cancel")})]})]})},xr=({user:t})=>{const{t:r}=q("users"),{addAlert:i,addError:c}=te(),[l,a]=f.exports.useState(0),u=()=>a(new Date().getTime()),[m,d]=f.exports.useState([]),[n,p]=f.exports.useState(""),[o,g]=f.exports.useState(!0),[y,I]=f.exports.useState([]),[G,S]=f.exports.useState(!1),{enabled:N}=Pt(),{hasAccess:re}=Me(),H=re("manage-users"),{adminClient:R}=W(),E=C=>Ze(C,z=>z.path?.toUpperCase()),F=async(C,z,ne)=>{const le={first:C,max:z},ce=ne||"";ce&&(le.search=ce,p(ce));const Ie=await R.users.listGroups({...le,id:t.id}),ve=await R.groups.find(),we=Ie.reduce((P,Q)=>(Q.path&&P.push(Q.path),P),[]),v=[],B=[],Y=[],ie=[...ve];let s=[];const w=(P,Q,X)=>{if(Q(P,X),typeof P!="object")return X;if(Array.isArray(P))return P.forEach(se=>w(se,Q,X)),X;for(const se in P)w(P[se],Q,X);return X},x=w(ie,(P,Q)=>{P?.subGroups&&Q.push(P.subGroups)},[]),A=[].concat(...x);s=[...ie,...A],we.forEach(P=>{const Q=P.split("/"),X=[];Q.reduce((se,ut)=>{const Ve=se+"/"+ut;return X.push(Ve),Ve},"");for(let se=1;se<X.length;se++)Y.push(X[se].substring(1))}),B.push(...Y),s.forEach(P=>{P.subGroups.length!==0&&s.push(...P.subGroups)}),s=s.filter(P=>B.includes(P.path));const D=ve.filter(P=>v.includes(P.name)),oe=[];D.forEach(P=>oe.push(P.subGroups));const j=Ie.filter(P=>!D.includes(P));I(j);const Te=s.filter((P,Q,X)=>Q===X.findIndex(se=>se.name===P.name));return E(o?j:Te)};f.exports.useEffect(()=>{u()},[o]);const L=C=>C.name,M=()=>{S(!G)},[h,b]=ye({titleKey:r("leaveGroup",{count:m.length,name:m[0]?.name}),messageKey:r("leaveGroupConfirmDialog",{count:m.length,groupname:m[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:fe.danger,onConfirm:async()=>{try{await Promise.all(m.map(C=>R.users.delFromGroup({id:t.id,groupId:C.id}))),u(),i(r("removedGroupMembership"),O.success)}catch(C){c("users:removedGroupMembershipError",C)}}}),T=C=>{d(C),h()},_=C=>(y.some(ne=>ne.id===C.id)||y.length===0||o)&&e(K,{"data-testid":`leave-${C.name}`,onClick:()=>T([C]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:r("leave")}),ae=async C=>{C.forEach(async ne=>{try{await R.users.addToGroup({id:t.id,groupId:ne.id}),u(),i(r("addedGroupMembership"),O.success)}catch(le){c("users:addedGroupMembershipError",le)}})},ke=C=>e(Wt,{group:C});return k(J,{children:[e(b,{}),G&&e(st,{id:t.id,type:"selectMany",text:{title:r("joinGroupsFor",{username:t.username}),ok:"users:join"},canBrowse:H,onClose:()=>S(!1),onConfirm:C=>{ae(C||[]),S(!1),u()}}),e(Le,{loader:F,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roles:roleList",searchPlaceholderKey:"groups:searchGroup",canSelectAll:!0,onSelect:C=>d(o?C:Ir(C,y,"id")),isRowDisabled:C=>!o&&y.every(z=>z.id!==C.id),toolbarItem:k(J,{children:[e(K,{className:"kc-join-group-button",onClick:M,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:r("joinGroup")}),e(or,{label:r("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>g(!o),isChecked:o,className:"direct-membership-check"},"direct-membership-check"),e(K,{onClick:()=>T(m),"data-testid":"leave-group-button",variant:"link",isDisabled:m.length===0,children:r("leave")}),N&&e($t,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:r("whoWillAppearPopoverText")}),children:e(K,{variant:"link",className:"kc-who-will-appear-button",icon:e(dr,{}),children:r("whoWillAppearLinkText")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"users:groupMembership",cellRenderer:L,cellFormatters:[Z()],transforms:[$(40)]},{name:"path",displayKey:"users:path",cellRenderer:ke,transforms:[$(45)]},{name:"",cellRenderer:_,cellFormatters:[Z()],transforms:[$(20)]}],emptyState:n?"":e(Oe,{hasIcon:!0,message:r("noGroups"),instructions:r("noGroupsText"),primaryActionText:r("joinGroup"),onPrimaryAction:M})},l)]})},Sr=()=>{const[t,r]=f.exports.useState(),{t:i}=q("roles"),{addAlert:c,addError:l}=te(),a=rt(),[u,m]=f.exports.useState(0),{adminClient:d}=W(),{id:n}=Se(),p=S=>Ze(S,N=>N.clientId?.toUpperCase()),o=()=>m(new Date().getTime()),g=async()=>{const S=await d.users.listConsents({id:n});return p(S)},y=({grantedClientScopes:S})=>e(it,{className:"kc-consents-chip-group",children:S.map(N=>e(ot,{isReadOnly:!0,className:"kc-consents-chip",id:"consents-chip-text",children:N},N))}),[I,G]=ye({titleKey:"users:revokeClientScopesTitle",messageKey:i("users:revokeClientScopes",{clientId:t?.clientId}),continueButtonLabel:"common:revoke",continueButtonVariant:fe.danger,onConfirm:async()=>{try{await d.users.revokeConsent({id:n,clientId:t.clientId}),o(),c(i("deleteGrantsSuccess"),O.success)}catch(S){l("roles:deleteGrantsError",S)}}});return k(J,{children:[e(G,{}),e(Le,{loader:g,ariaLabelKey:"roles:roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"clients:Client",cellFormatters:[Z()],transforms:[$(20)]},{name:"grantedClientScopes",displayKey:"client-scopes:grantedClientScopes",cellFormatters:[Z()],cellRenderer:y,transforms:[$(30)]},{name:"createDate",displayKey:"clients:created",transforms:[$(20)],cellRenderer:({createDate:S})=>S?a(new Date(S)):"\u2014"},{name:"lastUpdatedDate",displayKey:"clients:lastUpdated",transforms:[$(10)],cellRenderer:({lastUpdatedDate:S})=>S?a(new Date(S)):"\u2014"}],actions:[{title:i("users:revoke"),onRowClick:S=>{r(S),I()}}],emptyState:e(Oe,{hasIcon:!0,icon:lr,message:i("users:noConsents"),instructions:i("users:noConsentsText")})},u)]})},Tr=({federatedId:t,handleModalToggle:r,refresh:i})=>{const{t:c}=q("users"),{adminClient:l}=W(),{addAlert:a,addError:u}=te(),{register:m,handleSubmit:d,formState:{isValid:n,errors:p}}=Ce({mode:"onChange"}),{id:o}=Se(),g=async y=>{try{await l.users.addToFederatedIdentity({id:o,federatedIdentityId:t,federatedIdentity:y}),a(c("users:idpLinkSuccess"),O.success),r(),i()}catch(I){u("users:couldNotLinkIdP",I)}};return e(lt,{variant:qe.small,title:c("users:linkAccountTitle",{provider:xe(t)}),isOpen:!0,onClose:r,actions:[e(K,{"data-testid":c("link"),variant:"primary",type:"submit",form:"group-form",isDisabled:!n,children:c("link")},"confirm"),e(K,{id:"modal-cancel","data-testid":"cancel",variant:fe.link,onClick:()=>{r()},children:c("common:cancel")},"cancel")],children:k(Fe,{id:"group-form",onSubmit:d(g),children:[e(U,{name:"idp-name-group",label:c("users:identityProvider"),fieldId:"idp-name",helperTextInvalid:c("common:required"),validated:p.identityProvider?V.error:V.default,children:e(de,{"data-testid":"idpNameInput","aria-label":"Identity provider name input",ref:m({required:!0}),autoFocus:!0,isReadOnly:!0,type:"text",id:"link-idp-name",name:"identityProvider",value:xe(t),validated:p.identityProvider?V.error:V.default})}),e(U,{name:"user-id-group",label:c("users:userID"),fieldId:"user-id",helperText:c("users-help:userIdHelperText"),helperTextInvalid:c("common:required"),validated:p.userId?V.error:V.default,isRequired:!0,children:e(de,{"data-testid":"userIdInput","aria-label":"user ID input",ref:m({required:!0}),autoFocus:!0,type:"text",id:"link-idp-user-id",name:"userId",validated:p.userId?V.error:V.default})}),e(U,{name:"username-group",label:c("users:username"),fieldId:"username",helperText:c("users-help:usernameHelperText"),helperTextInvalid:c("common:required"),validated:p.name?V.error:V.default,isRequired:!0,children:e(de,{"data-testid":"usernameInput","aria-label":"username input",ref:m({required:!0}),autoFocus:!0,type:"text",id:"link-idp-username",name:"userName",validated:p.name?V.error:V.default})})]})})},Ar=()=>{const[t,r]=f.exports.useState(0),[i,c]=f.exports.useState(""),[l,a]=f.exports.useState(!1),{adminClient:u}=W(),{id:m}=Se(),{realm:d}=De(),{addAlert:n,addError:p}=te(),{t:o}=q("users"),g=()=>r(new Date().getTime()),y=()=>{a(!l)},I=Lt().identityProviders,G=async()=>{const b=await u.identityProviders.find(),T=await u.users.listFederatedIdentities({id:m});for(const _ of T)_.providerId=b.find(ae=>ae.alias===_.identityProvider)?.providerId;return T},S=async()=>(await u.realms.findOne({realm:d})).identityProviders,N=async()=>G(),re=async()=>{const b=(await G()).map(T=>T.identityProvider);return(await S())?.filter(T=>!b.includes(T.alias))},[H,R]=ye({titleKey:o("users:unlinkAccountTitle",{provider:xe(i)}),messageKey:o("users:unlinkAccountConfirm",{provider:xe(i)}),continueButtonLabel:"users:unlink",continueButtonVariant:fe.primary,onConfirm:async()=>{try{await u.users.delFromFederatedIdentity({id:m,federatedIdentityId:i}),n(o("users:idpUnlinkSuccess"),O.success),g()}catch(b){p("common:mappingDeletedError",b)}}}),E=b=>e(Rt,{to:Ft({realm:d,providerId:b.providerId,alias:b.identityProvider,tab:"settings"}),children:xe(b.identityProvider)}),F=b=>{const T=I?.find(_=>_.id===b.identityProvider)?.groupName;return e(_e,{color:T==="Social"?"blue":"orange",children:o(T==="Social"?"users:idpType.social":"users:idpType.custom")})},L=b=>{const T=I?.find(_=>_.id===b.providerId)?.groupName;return e(_e,{color:T==="User-defined"?"orange":"blue",children:T==="User-defined"?"Custom":T==="Social"?o("users:idpType.social"):T})},M=b=>e(K,{variant:"link",onClick:()=>{c(b.identityProvider),H()},children:o("unlinkAccount")}),h=b=>e(K,{variant:"link",onClick:()=>{c(b.alias),a(!0)},children:o("linkAccount")});return k(J,{children:[l&&e(Tr,{federatedId:i,handleModalToggle:y,refresh:g}),e(R,{}),k(be,{variant:"light",className:"pf-u-p-0",children:[k($e,{title:o("linkedIdPs"),className:"kc-linked-idps",children:[e(Ae,{children:e(Pe,{className:"kc-available-idps-text",children:o("linkedIdPsText")})}),e(Le,{loader:N,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"identityProvider",displayKey:"common:name",cellFormatters:[Z()],cellRenderer:E,transforms:[$(20)]},{name:"type",displayKey:"common:type",cellFormatters:[Z()],cellRenderer:F,transforms:[$(10)]},{name:"userId",displayKey:"users:userID",cellFormatters:[Z()],transforms:[$(30)]},{name:"userName",displayKey:"users:username",cellFormatters:[Z()],transforms:[$(20)]},{name:"",cellFormatters:[Z()],cellRenderer:M,transforms:[$(20)]}],emptyState:e(Ae,{className:"kc-no-providers-text",children:e(Pe,{children:o("users:noProvidersLinked")})})},t)]}),k($e,{className:"kc-available-idps",title:o("availableIdPs"),children:[e(Ae,{children:e(Pe,{className:"kc-available-idps-text",children:o("availableIdPsText")})}),e(Le,{loader:re,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"common:name",cellFormatters:[Z(),Dt()],transforms:[$(20)]},{name:"type",displayKey:"common:type",cellFormatters:[Z()],cellRenderer:L,transforms:[$(60)]},{name:"",cellFormatters:[Z()],cellRenderer:h}],emptyState:e(Ae,{className:"kc-no-providers-text",children:e(Pe,{children:o("users:noAvailableIdentityProviders")})})},t)]})]})]})},Pr=({id:t,name:r})=>{const{t:i}=q("users"),{adminClient:c}=W(),{addAlert:l,addError:a}=te();return e(ur,{name:r,id:t,type:"users",save:async m=>{try{const d=m.filter(n=>n.client===void 0).map(n=>n.role).flat();await c.users.addRealmRoleMappings({id:t,roles:d}),await Promise.all(m.filter(n=>n.client!==void 0).map(n=>c.users.addClientRoleMappings({id:t,clientUniqueId:n.client.id,roles:[n.role]}))),l(i("roleMappingUpdatedSuccess"),O.success)}catch(d){a("clients:roleMappingUpdatedError",d)}}})},Lr=({user:t})=>{const{t:r}=q("users"),{adminClient:i}=W(),{addAlert:c,addError:l}=te(),[a,u]=f.exports.useState(t),m=Ce({mode:"onChange"}),d=p=>Gt(p||a.attributes);f.exports.useEffect(()=>{m.setValue("attributes",d())},[a]);const n=async p=>{try{const o=Nt(p.attributes);await i.users.update({id:a.id},{...a,attributes:o}),u({...a,attributes:o}),c(r("userSaved"),O.success)}catch(o){l("groups:groupUpdateError",o)}};return e(be,{variant:et.light,children:e(mr,{form:m,save:n,fineGrainedAccess:a.access?.manage,reset:()=>m.reset({attributes:d()})})})},Dr={password:"",passwordConfirmation:"",temporaryPassword:!0},Rr=({user:t,isResetPassword:r,refresh:i,onClose:c})=>{const{t:l}=q("users"),{register:a,control:u,formState:{isValid:m,errors:d},watch:n,handleSubmit:p}=Ce({defaultValues:Dr,mode:"onChange",shouldUnregister:!1}),[o,g]=Ke(!0),y=n("password",""),{adminClient:I}=W(),{addAlert:G,addError:S}=te(),[N,re]=ye({titleKey:r?"users:resetPasswordConfirm":"users:setPasswordConfirm",messageKey:r?l("resetPasswordConfirmText",{username:t.username}):l("setPasswordConfirmText",{username:t.username}),continueButtonLabel:r?"users:resetPassword":"users:savePassword",continueButtonVariant:fe.danger,onConfirm:()=>p(H)()}),H=async({password:R,temporaryPassword:E})=>{try{await I.users.resetPassword({id:t.id,credential:{temporary:E,type:"password",value:R}});const L=(await I.users.getCredentials({id:t.id})).find(M=>M.type==="password");L&&await I.users.updateCredentialLabel({id:t.id,credentialId:L.id},l("defaultPasswordLabel")),G(l(r?"resetCredentialsSuccess":"savePasswordSuccess"),O.success),i()}catch(F){S(r?"users:resetPasswordError":"users:savePasswordError",F)}c()};return k(J,{children:[e(re,{}),e(dt,{titleKey:r?l("resetPasswordFor",{username:t.username}):l("setPasswordFor",{username:t.username}),open:o,onCancel:c,toggleDialog:g,onConfirm:N,confirmButtonDisabled:!m,continueButtonLabel:"common:save",children:k(Fe,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[e(U,{name:"password",label:l("password"),fieldId:"password",helperTextInvalid:l("common:required"),validated:d.password?V.error:V.default,isRequired:!0,children:e(We,{"data-testid":"passwordField",name:"password","aria-label":"password",ref:a({required:!0})})}),e(U,{name:"passwordConfirmation",label:l(r?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",helperTextInvalid:d.passwordConfirmation?.message,validated:d.passwordConfirmation?V.error:V.default,isRequired:!0,children:e(We,{"data-testid":"passwordConfirmationField",name:"passwordConfirmation","aria-label":"passwordConfirm",ref:a({required:!0,validate:R=>R===y||l("confirmPasswordDoesNotMatch").toString()})})}),e(U,{label:l("common:temporaryPassword"),labelIcon:e(pe,{helpText:"temporaryPasswordHelpText",fieldLabelId:"temporaryPassword"}),fieldId:"kc-temporaryPassword",children:e(ge,{name:"temporaryPassword",defaultValue:!0,control:u,render:({onChange:R,value:E})=>e(Ee,{className:"kc-temporaryPassword",onChange:R,isChecked:E,label:l("common:on"),labelOff:l("common:off"),"aria-label":l("common:temporaryPassword")})})})]})})]})},Fr=()=>{const{t}=q("users"),{adminClient:r}=W(),{control:i}=Be(),[c,l]=f.exports.useState(!1),[a,u]=f.exports.useState([]);return Re(()=>r.authenticationManagement.getRequiredActions(),m=>{u(m)},[]),e(U,{label:t("resetActions"),labelIcon:e(pe,{helpText:"clients-help:resetActions",fieldLabelId:"resetActions"}),fieldId:"actions",children:e(ge,{name:"actions",defaultValue:[],control:i,render:({onChange:m,value:d})=>e(at,{toggleId:"actions",variant:Jt.typeaheadMulti,chipGroupProps:{numChips:3},menuAppendTo:"parent",onToggle:n=>l(n),isOpen:c,selections:d,onSelect:(n,p)=>m(d.find(o=>o===p)?d.filter(o=>o!==p):[...d,p]),onClear:n=>{n.stopPropagation(),m([])},typeAheadAriaLabel:t("resetActions"),children:a.map(({alias:n,name:p})=>e(nt,{value:n,"data-testid":`${n}-option`,children:p},n))})})})},Gr=()=>{const{t}=q("users"),{control:r}=Be();return e(U,{fieldId:"lifespan",label:t("lifespan"),isStack:!0,labelIcon:e(pe,{helpText:"clients-help:lifespan",fieldLabelId:"lifespan"}),children:e(ge,{name:"lifespan",defaultValue:ct.lifespan,control:r,render:({onChange:i,value:c})=>e(pr,{value:c,units:["minute","hour","day"],onChange:i,menuAppendTo:"parent"})})})},ct={actions:[],lifespan:43200},Nr=({userId:t,onClose:r})=>{const{t:i}=q("users"),c=Ce({defaultValues:ct}),{handleSubmit:l,control:a}=c,u=Ht({control:a,name:"actions"}),m=!Ye(u),{adminClient:d}=W(),{addAlert:n,addError:p}=te(),o=async({actions:g,lifespan:y})=>{if(!Ye(g))try{await d.users.executeActionsEmail({id:t,actions:g,lifespan:y}),n(i("credentialResetEmailSuccess"),O.success),r()}catch(I){p("users:credentialResetEmailError",I)}};return e(dt,{variant:qe.medium,titleKey:"users:credentialReset",open:!0,onCancel:r,toggleDialog:r,continueButtonLabel:"users:credentialResetConfirm",onConfirm:()=>{l(o)()},confirmButtonDisabled:!m,children:e(Fe,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:k(tt,{...c,children:[e(Fr,{}),e(Gr,{})]})})})},Er=({userId:t,credential:r,isEditable:i,toggle:c})=>{const{t:l}=q("users"),{register:a,handleSubmit:u}=Ce(),{adminClient:m}=W(),{addAlert:d,addError:n}=te();return e(Fe,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:u(async o=>{try{await m.users.updateCredentialLabel({id:t,credentialId:r.id},o.userLabel||""),d(l("updateCredentialUserLabelSuccess"),O.success),c()}catch(g){n("users:updateCredentialUserLabelError",g)}}),children:e(U,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:i?k(J,{children:[e(de,{name:"userLabel","data-testid":"userLabelFld",defaultValue:r.userLabel,ref:a(),type:"text",className:"kc-userLabel","aria-label":l("userLabel")}),k("div",{className:"kc-userLabel-actionBtns",children:[e(K,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn",type:"submit",icon:e(Et,{})}),e(K,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn",onClick:c,icon:e(Ut,{})})]})]}):k(J,{children:[r.userLabel,e(K,{"aria-label":l("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:c,"data-testid":"editUserLabelBtn",icon:e(Xt,{})})]})})})})},Ur=({credentialData:t,onClose:r})=>{const{t:i}=q("users");return e(lt,{variant:qe.medium,title:i("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:r,children:k(Zt,{"aria-label":i("passwordDataTitle"),"data-testid":"password-data-dialog",variant:sr.compact,cells:[i("showPasswordDataName"),i("showPasswordDataValue")],rows:t,children:[e(er,{}),e(tr,{})]})})},Kr=({credential:t,resetPassword:r,toggleDelete:i,children:c})=>{const{t:l}=q("users"),[a,u]=Ke(),[m,d]=Ke(),n=fr(),p=f.exports.useMemo(()=>{if(!t.credentialData)return[];const o=JSON.parse(t.credentialData);return n(Object.entries(o),([g])=>g).map(([g,y])=>typeof y=="string"?[g,y]:[g,JSON.stringify(y)])},[t.credentialData]);return k(J,{children:[a&&Object.keys(t).length!==0&&e(Ur,{credentialData:p,onClose:()=>{u()}}),e(ee,{children:c}),e(ee,{children:e(K,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:u,children:l("showDataBtn")})}),t.type==="password"?e(ee,{isActionCell:!0,children:e(K,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:r,children:l("resetPasswordBtn")})}):e(ee,{}),e(ee,{isActionCell:!0,children:e(Kt,{isPlain:!0,position:Mt.right,toggle:e(Bt,{onToggle:d}),isOpen:m,dropdownItems:[e(Ue,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{i(),d()},children:l("deleteBtn")},t.id)]})})]})};const Mr=({user:t})=>{const{t:r}=q("users"),{addAlert:i,addError:c}=te(),[l,a]=f.exports.useState(0),u=()=>a(l+1),[m,d]=f.exports.useState(!1),[n,p]=f.exports.useState(!1),{adminClient:o}=W(),[g,y]=f.exports.useState([]),[I,G]=f.exports.useState([]),[S,N]=f.exports.useState({}),[re,H]=f.exports.useState(!1),[R,E]=f.exports.useState(),F=f.exports.useRef(null),[L,M]=f.exports.useState({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});Re(()=>o.users.getCredentials({id:t.id}),s=>{y(s);const w=s.reduce((A,D)=>(A[D.type]=A[D.type]||[],A[D.type].push(D),A),Object.create(null)),x=Object.keys(w).map(A=>({key:A,value:w[A]}));G(x.map(A=>({...A,isExpanded:!1})))},[l]);const h=g.find(s=>s.type==="password"),b=()=>d(!m),T=()=>{p(!n)},_=()=>{H(!0),b()},[ae,ke]=ye({titleKey:r("deleteCredentialsConfirmTitle"),messageKey:r("deleteCredentialsConfirm"),continueButtonLabel:r("common:delete"),continueButtonVariant:fe.danger,onConfirm:async()=>{try{await o.users.deleteCredential({id:t.id,credentialId:S.id}),i(r("deleteCredentialsSuccess"),O.success),a(s=>s+1)}catch(s){c("users:deleteCredentialsError",s)}}}),C=({credential:s})=>e(Kr,{credential:s,toggleDelete:()=>{N(s),ae()},resetPassword:_,children:e(Er,{credential:s,userId:t.id,isEditable:R?.status&&R.rowKey===s.id||!1,toggle:()=>{E({status:!R?.status,rowKey:s.id}),R?.status&&u()}})},s.id),z=f.exports.useMemo(()=>I.flatMap(s=>[s.value.map(({id:w})=>w).toString(),...s.isExpanded?s.value.map(w=>w.id):[]]),[I]),ne=s=>{s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",s.currentTarget.id);const w=s.currentTarget.id;s.currentTarget.classList.add(Ne.modifiers.ghostRow),s.currentTarget.setAttribute("aria-pressed","true"),M({...L,draggedItemId:w,dragging:!0})},le=(s,w,x)=>{const A=s.indexOf(w);if(A===x)return s;const D=[...s];return D.splice(x,0,D.splice(A,1)[0]),D},ce=s=>{if(!F.current)return;const w=F.current,x=Array.from(w.children);x.every(({id:A},D)=>A===s[D])||(w.replaceChildren(),s.forEach(A=>{w.appendChild(x.find(({id:D})=>D===A))}))},Ie=()=>{!F.current||(Array.from(F.current.children).forEach(s=>{s.classList.remove(Ne.modifiers.ghostRow),s.setAttribute("aria-pressed","false")}),M({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},ve=s=>{we(s)||(ce(z),M({...L,draggingToItemIndex:-1}))},we=s=>{if(!F.current)return!1;const w=F.current.getBoundingClientRect();return s.clientX>w.x&&s.clientX<w.x+w.width&&s.clientY>w.y&&s.clientY<w.y+w.height},v=s=>{we(s)?ie(L.draggedItemId,L.tempItemOrder):Ie()},B=s=>{s.preventDefault();const x=s.target.closest("tr");if(!(!x||F.current&&!F.current.contains(x)||x.id===L.draggedItemId)){const A=x.id,D=Array.from(F.current?.children||[]).findIndex(j=>j.id===A);if(D===L.draggingToItemIndex)return;const oe=le(z,L.draggedItemId,D);ce(oe),M({...L,draggingToItemIndex:D,tempItemOrder:oe})}},Y=({target:s})=>{s instanceof HTMLTableRowElement&&(s.classList.remove(Ne.modifiers.ghostRow),s.setAttribute("aria-pressed","false"),M({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},ie=async(s,w)=>{const x=z.findIndex(j=>j===s),A=w.findIndex(j=>j===s),D=A-x,oe=s.split(",");try{for(const j of oe)for(let Te=0;Te<Math.abs(D);Te++)D>0?await o.users.moveCredentialPositionDown({id:t.id,credentialId:j,newPreviousCredentialId:z[A]}):await o.users.moveCredentialPositionUp({id:t.id,credentialId:j});u(),i(r("users:updatedCredentialMoveSuccess"),O.success)}catch(j){c("users:updatedCredentialMoveError",j)}};return k(J,{children:[m&&e(Rr,{user:t,isResetPassword:re,refresh:u,onClose:()=>d(!1)}),n&&e(Nr,{userId:t.id,onClose:()=>p(!1)}),e(ke,{}),g.length!==0&&h===void 0&&k(J,{children:[e(K,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{d(!0)},children:r("setPassword")}),e(Ot,{})]}),I.length!==0?k(J,{children:[t.email&&e(K,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>p(!0),children:r("credentialResetBtn")}),e(be,{variant:et.light,children:k(ar,{"aria-label":"userCredentials-table",variant:"compact",children:[e(nr,{children:k(Ge,{className:"kc-table-header",children:[e(he,{children:e(pe,{helpText:"users:userCredentialsHelpText",fieldLabelId:"users:userCredentialsHelpTextLabel"})}),e(he,{}),e(he,{children:r("type")}),e(he,{children:r("userLabel")}),e(he,{children:r("data")}),e(he,{}),e(he,{})]})}),e(ir,{ref:F,onDragOver:B,onDrop:B,onDragLeave:ve,children:I.map((s,w)=>k(f.exports.Fragment,{children:[k(Ge,{id:s.value.map(({id:x})=>x).toString(),draggable:I.length>1,onDrop:v,onDragEnd:Y,onDragStart:ne,children:[e(ee,{className:I.length===1?"one-row":"",draggableRow:{id:`draggable-row-${s.value.map(({id:x})=>x)}`}}),s.value.length>1?e(ee,{className:"kc-expandRow-btn",expand:{rowIndex:w,isExpanded:s.isExpanded,onToggle:(x,A)=>{const D=I.map((oe,j)=>j===A?{...oe,isExpanded:!oe.isExpanded}:oe);G(D)}}}):e(ee,{}),e(ee,{dataLabel:`columns-${s.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:ze(s.key)}),s.value.length<=1&&s.value.map(x=>e(C,{credential:x},x.id))]}),s.isExpanded&&s.value.map(x=>k(Ge,{id:x.id,draggable:!0,onDrop:v,onDragEnd:Y,onDragStart:ne,children:[e(ee,{}),e(ee,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${s.value.map(({id:A})=>A)}`}}),e(ee,{dataLabel:`child-columns-${x.id}`,className:"kc-expandableRow-credentialType",children:ze(x.type)}),e(C,{credential:x})]},x.id))]},s.key))})]})})]}):e(Oe,{hasIcon:!0,message:r("noCredentials"),instructions:r("noCredentialsText"),primaryActionText:r("setPassword"),onPrimaryAction:b,secondaryActions:t.email?[{text:r("credentialResetBtn"),onClick:T,type:fe.link}]:void 0})]})},Br=()=>{const{adminClient:t}=W(),{id:r}=Se(),{realm:i}=De(),{t:c}=q("sessions");return e(be,{variant:"light",className:"pf-u-p-0",children:e(cr,{loader:()=>t.users.listSessions({id:r,realm:i}),hiddenColumns:["username"],emptyInstructions:c("noSessionsForUser"),logoutUser:r})})},Ks=()=>{const{t}=q("users"),{addAlert:r,addError:i}=te(),c=Xe(),{realm:l}=De(),{hasAccess:a}=Me(),{adminClient:u}=W(),m=Ce({mode:"onChange"}),{id:d}=Se(),[n,p]=f.exports.useState(),[o,g]=f.exports.useState(),[y,I]=f.exports.useState([]),[G,S]=f.exports.useState(0),N=()=>S(h=>h+1);Re(async()=>{if(d){const h=await u.users.findOne({id:d});if(!h)throw new Error(t("common:notFound"));const b=(await u.realms.findOne({realm:l})).bruteForceProtected,T=await u.attackDetection.findOne({id:h.id}),_=b&&T&&T.disabled;return{user:h,bruteForced:{isBruteForceProtected:b,isLocked:_}}}return{user:void 0}},({user:h,bruteForced:b})=>{p(h),g(b),h&&re(h)},[n?.username,G]);const re=h=>{m.reset(h)},H=h=>{I(h)},R=async h=>{h.username=h.username?.trim();try{if(d)await u.users.update({id:d},h),r(t("userSaved"),O.success),N();else{h.groups=y.map(T=>T.path);const b=await u.users.create(h);r(t("userCreated"),O.success),c(jt({id:b.id,realm:l,tab:"settings"}))}}catch(b){i("users:userCreateError",b)}},[E,F]=ye({titleKey:"users:deleteConfirm",messageKey:"users:deleteConfirmCurrentUser",continueButtonLabel:"common:delete",continueButtonVariant:fe.danger,onConfirm:async()=>{try{await u.users.del({id:d}),r(t("userDeletedSuccess"),O.success),c(qt({realm:l}))}catch(h){i("users:userDeletedError",h)}}}),[L,M]=ye({titleKey:"users:impersonateConfirm",messageKey:"users:impersonateConfirmDialog",continueButtonLabel:"users:impersonate",onConfirm:async()=>{try{const h=await u.users.impersonation({id:d},{user:d,realm:l});h.sameRealm?window.location=h.redirect:window.open(h.redirect,"_blank")}catch(h){i("users:impersonateError",h)}}});return d&&!n?e(Vt,{}):k(J,{children:[e(M,{}),e(F,{}),e(ge,{name:"enabled",control:m.control,defaultValue:!0,render:({onChange:h,value:b})=>e(_t,{titleKey:n?.id?n.username:t("createUser"),divider:!d,dropdownItems:[e(Ue,{isDisabled:!n?.access?.impersonate,onClick:()=>L(),children:t("impersonate")},"impersonate"),e(Ue,{isDisabled:!n?.access?.manage,onClick:()=>E(),children:t("common:delete")},"delete")],isEnabled:b,onToggle:T=>{h(T),R(m.getValues())}})}),e(be,{variant:"light",className:"pf-u-p-0",children:k(tt,{...m,children:[d&&n&&k(Qt,{isBox:!0,mountOnEnter:!0,children:[e(ue,{eventKey:"settings","data-testid":"user-details-tab",title:e(me,{children:t("common:details")}),children:e(be,{variant:"light",children:o&&e(Je,{onGroupsUpdate:H,save:R,user:n,bruteForce:o})})}),e(ue,{eventKey:"attributes","data-testid":"attributes",title:e(me,{children:t("common:attributes")}),children:e(Lr,{user:n})}),e(ue,{eventKey:"credentials","data-testid":"credentials",isHidden:!n.access?.manage,title:e(me,{children:t("common:credentials")}),children:e(Mr,{user:n})}),e(ue,{eventKey:"role-mapping","data-testid":"role-mapping-tab",isHidden:!n.access?.mapRoles,title:e(me,{children:t("roleMapping")}),children:e(Pr,{id:d,name:n.username})}),e(ue,{eventKey:"groups","data-testid":"user-groups-tab",title:e(me,{children:t("common:groups")}),children:e(xr,{user:n})}),e(ue,{eventKey:"consents","data-testid":"user-consents-tab",title:e(me,{children:t("consents")}),children:e(Sr,{})}),a("view-identity-providers")&&e(ue,{eventKey:"identity-provider-links","data-testid":"identity-provider-links-tab",title:e(me,{children:t("identityProviderLinks")}),children:e(Ar,{})}),e(ue,{eventKey:"sessions","data-testid":"user-sessions-tab",title:e(me,{children:t("sessions")}),children:e(Br,{})})]}),!d&&e(be,{variant:"light",children:e(Je,{onGroupsUpdate:H,save:R})})]})})]})};export{Ks as default};
