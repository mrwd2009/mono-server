import{u as j,ay as z,r as S,a_ as H,j as e,aw as Y,bA as $,az as W,ae as E,aY as O,c5 as K,K as J,h as V,F as k,o as Q,ap as X,P as Z,aA as ee,s as B,b4 as se,bY as ie}from"./index.0cb2e516.js";import{a as te,C as G,u as oe,b as ae,F as re}from"./index.esm.6af887f8.js";import{u as ne}from"./ConfirmDialog.f8013bbb.js";import{V as le}from"./ViewHeader.2586557f.js";import{F as ce}from"./FormAccess.bee4f1e0.js";import{H as m}from"./HelpItem.e440d5db.js";import{R as U}from"./ResourcesPolicySelect.0de4bf6f.js";import{S as de,b as q,a as pe}from"./Select.5a6b39aa.js";import{K as M}from"./KeycloakTextInput.b4d5b2db.js";import{K as me}from"./KeycloakTextArea.f5e2440a.js";import{a as u,A as ue}from"./FormGroup.3d5f3f16.js";import{R as fe}from"./Radio.cfe305aa.js";import"./Modal.6593dfcc.js";import"./Text.c38ffb52.js";import"./copy-icon.cf10e1f5.js";import"./GridItem.0db472b0.js";import"./check.51c67984.js";import"./star-icon.97692015.js";const he=({clientId:s,resourceId:f,preSelected:h})=>{const{t:I}=j("clients"),{adminClient:A}=z(),{control:p,getValues:w,setValue:P,formState:{errors:a}}=te(),[T,r]=S.exports.useState([]),[t,g]=S.exports.useState([]),[n,b]=S.exports.useState(""),[C,v]=S.exports.useState(!1),D=S.exports.useRef(!0),L=w("scopes"),x=l=>l.map(c=>e(pe,{value:c,children:c.name},c.id));return H(async()=>f?(f&&!D.current&&P("scopes",[]),D.current=!1,A.clients.listScopesByResource({id:s,resourceName:f})):A.clients.listAllScopes(Object.assign({id:s,deep:!1},n===""?null:{name:n})),l=>{r(l),n||g(l.filter(c=>L?.includes(c.id)))},[f,n]),e(G,{name:"scopes",defaultValue:h?[h]:[],control:p,rules:{validate:l=>l.length>0},render:({onChange:l})=>e(de,{toggleId:"scopes",variant:q.typeaheadMulti,onToggle:v,onFilter:(c,y)=>(b(y),x(T)),onClear:()=>{l([]),b("")},selections:t.map(c=>c.name),onSelect:(c,y)=>{const R=typeof y=="string"?t.find(o=>o.name===y):y,i=t.find(o=>o.id===R.id)?t.filter(o=>o.id!==R.id):[...t,R];l(i.map(o=>o.id)),g(i),b("")},isOpen:C,"aria-labelledby":I("scopes"),validated:a.scopes?"error":"default",isDisabled:!!h,typeAheadAriaLabel:I("scopes"),children:x(T)})})},_=["UNANIMOUS","AFFIRMATIVE","CONSENSUS"];function qe(){const{t:s}=j("clients"),f=oe({shouldUnregister:!1,mode:"onChange"}),{register:h,control:I,reset:A,errors:p,handleSubmit:w}=f,P=Y(),{id:a,realm:T,permissionType:r,permissionId:t,selectedId:g}=$(),{adminClient:n}=z(),{addAlert:b,addError:C}=W(),[v,D]=S.exports.useState(),[L,x]=S.exports.useState(!1);H(async()=>{if(!t)return{};const[i,o,d,N]=await Promise.all([n.clients.findOnePermission({id:a,type:r,permissionId:t}),n.clients.getAssociatedResources({id:a,permissionId:t}),n.clients.getAssociatedPolicies({id:a,permissionId:t}),n.clients.getAssociatedScopes({id:a,permissionId:t})]);if(!i)throw new Error(s("common:notFound"));return{permission:i,resources:o.map(F=>F._id),policies:d.map(F=>F.id),scopes:N.map(F=>F.id)}},({permission:i,resources:o,policies:d,scopes:N})=>{A({...i,resources:o,policies:d,scopes:N}),i&&"resourceType"in i&&x(!!i.resourceType),D({...i,resources:o,policies:d})},[]);const l=async i=>{try{if(t)await n.clients.updatePermission({id:a,type:r,permissionId:t},i);else{const o=await n.clients.createPermission({id:a,type:r},i);P(ie({realm:T,id:a,permissionType:r,permissionId:o.id}))}b(s((t?"update":"create")+"PermissionSuccess"),O.success)}catch(o){C("clients:permissionSaveError",o)}},[c,y]=ne({titleKey:"clients:deletePermission",messageKey:s("deletePermissionConfirm",{permission:v?.name}),continueButtonVariant:E.danger,continueButtonLabel:"clients:confirm",onConfirm:async()=>{try{await n.clients.delPermission({id:a,type:r,permissionId:t}),b(s("permissionDeletedSuccess"),O.success),P(K({realm:T,clientId:a,tab:"permissions"}))}catch(i){C("clients:permissionDeletedError",i)}}}),R=ae({control:I,name:"resources",defaultValue:[]});return v?V(k,{children:[e(y,{}),e(le,{titleKey:t?v.name:`clients:create${Q(r)}BasedPermission`,dropdownItems:t?[e(X,{"data-testid":"delete-resource",onClick:()=>c(),children:s("common:delete")},"delete")]:void 0}),e(Z,{variant:"light",children:e(ce,{isHorizontal:!0,role:"view-clients",onSubmit:w(l),children:V(re,{...f,children:[e(u,{label:s("common:name"),isRequired:!0,helperTextInvalid:s("common:required"),validated:p.name?"error":"default",fieldId:"name",labelIcon:e(m,{helpText:"clients-help:permissionName",fieldLabelId:"name"}),children:e(M,{id:"name",name:"name",ref:h({required:!0}),validated:p.name?"error":"default"})}),e(u,{label:s("common:description"),fieldId:"description",labelIcon:e(m,{helpText:"clients-help:permissionDescription",fieldLabelId:"description"}),validated:p.description?"error":"default",helperTextInvalid:p.description?.message,children:e(me,{id:"description",name:"description",ref:h({maxLength:{value:255,message:s("common:maxLength",{length:255})}}),validated:p.description?"error":"default"})}),e(u,{label:s("applyToResourceTypeFlag"),fieldId:"applyToResourceTypeFlag",labelIcon:e(m,{helpText:"clients-help:applyToResourceTypeFlag",fieldLabelId:"clients:applyToResourceTypeFlag"}),children:e(ee,{id:"applyToResourceTypeFlag",name:"applyToResourceTypeFlag",label:s("common:on"),labelOff:s("common:off"),isChecked:L,onChange:x,"aria-label":s("applyToResourceTypeFlag")})}),L?e(u,{label:s("resourceType"),fieldId:"name",labelIcon:e(m,{helpText:"clients-help:resourceType",fieldLabelId:"resourceType"}),isRequired:r==="scope",children:e(M,{id:"resourceType",name:"resourceType",ref:h({required:r==="scope"})})}):e(u,{label:s("resources"),fieldId:"resources",labelIcon:e(m,{helpText:"clients-help:permissionResources",fieldLabelId:"clients:resources"}),helperTextInvalid:s("common:required"),validated:p.resources?"error":"default",isRequired:r!=="scope",children:e(U,{name:"resources",clientId:a,permissionId:t,preSelected:r==="scope"?void 0:g,variant:r==="scope"?q.typeahead:q.typeaheadMulti,isRequired:r!=="scope"})}),r==="scope"&&e(u,{label:s("authorizationScopes"),fieldId:"scopes",labelIcon:e(m,{helpText:"clients-help:permissionScopes",fieldLabelId:"clients:scopesSelect"}),helperTextInvalid:s("common:required"),validated:p.scopes?"error":"default",isRequired:!0,children:e(he,{clientId:a,resourceId:R?.[0],preSelected:g})}),e(u,{label:s("policies"),fieldId:"policies",labelIcon:e(m,{helpText:"clients-help:permissionPolicies",fieldLabelId:"clients:policies"}),children:e(U,{name:"policies",clientId:a,permissionId:t})}),e(u,{label:s("decisionStrategy"),labelIcon:e(m,{helpText:"clients-help:permissionDecisionStrategy",fieldLabelId:"clients:decisionStrategy"}),fieldId:"policyEnforcementMode",hasNoPaddingTop:!0,children:e(G,{name:"decisionStrategy","data-testid":"decisionStrategy",defaultValue:_[0],control:I,render:({onChange:i,value:o})=>e(k,{children:_.map(d=>e(fe,{id:d,"data-testid":d,isChecked:o===d,name:"decisionStrategies",onChange:()=>i(d),label:s(`decisionStrategies.${d}`),className:"pf-u-mb-md"},d))})})}),e(ue,{children:V("div",{className:"pf-u-mt-md",children:[e(B,{variant:E.primary,type:"submit","data-testid":"save",children:s("common:save")}),e(B,{variant:"link","data-testid":"cancel",component:i=>e(se,{...i,to:K({realm:T,clientId:a,tab:"permissions"})}),children:s("common:cancel")})]})})]})})})]}):e(J,{})}export{qe as default};
