"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,n,i){i===void 0&&(i=n);var o=Object.getOwnPropertyDescriptor(a,n);(!o||("get"in o?!a.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return a[n]}}),Object.defineProperty(e,i,o)}:function(e,a,n,i){i===void 0&&(i=n),e[i]=a[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(e!=null)for(var n in e)n!=="default"&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(a,e,n);return __setModuleDefault(a,e),a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.connectTo=void 0;const fs_1=__importDefault(require("fs")),core_1=__importStar(require("@sequelize/core")),path_1=__importDefault(require("path")),lodash_1=__importDefault(require("lodash")),config_1=__importDefault(require("../config/config")),handler_1=require("../lib/signal/handler"),connectTo=e=>{const{database:a,username:n=config_1.default.database.main.username,password:i=config_1.default.database.main.password,host:o=config_1.default.database.main.host,modelDir:p="main",...b}=e,m=lodash_1.default.parseInt(`${e.port||config_1.default.database.main.port||config_1.default.database.basic.port}`),_=path_1.default.join(__dirname,p),d=new core_1.Sequelize(a,n,i,{host:o,port:m,dialect:"mysql",pool:config_1.default.database.poolConfig,logQueryParameters:config_1.default.isDev,benchmark:config_1.default.isDev,logging:(t,s,l={})=>{const{model:u}=l;if(config_1.default.isDev){const c=`${u?`${u.name} `:""}`,h=(s||0)>100?`\x1B[38;2;205;0;205m${s}ms\x1B[0m`:`${s||0}ms`;console.log("\x1B[38;2;0;204;204m%s\x1B[0m \x1B[38;2;0;0;238m%s\x1B[0m",`${a}(${c}${h})`,t)}},...b}),r={sequelize:d,Sequelize:core_1.default,models:{}};fs_1.default.readdirSync(_).filter(t=>{const s=t.slice(-3);return[".ts",".js"].includes(s)&&t!=="index.ts"&&t!=="index.js"}).forEach(t=>{const s=require(path_1.default.join(_,t)).initialize(d,config_1.default),l=lodash_1.default.get(s,"name");r.models[l]=s}),lodash_1.default.forEach(lodash_1.default.keys(r.models),t=>{const s=r.models[t],l=lodash_1.default.get(s,"associate");l&&l(r.models)});const f=r.sequelize.transaction;return r.sequelize.transaction=(...t)=>{if(lodash_1.default.isFunction(t[1]||t[0])){const s=t[1]||t[0],l=u=>s(u).catch(c=>{throw c.parent&&c.parent.code==="ER_LOCK_DEADLOCK"&&u.cleanup(),c});return t[1]?f.call(r.sequelize,t[0],l):f.call(r.sequelize,l)}return f.apply(r.sequelize,t)},(0,handler_1.registerCleanupHandler)(async()=>{await d.close()}),r};exports.connectTo=connectTo;