"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){r===void 0&&(r=i);var n=Object.getOwnPropertyDescriptor(t,i);(!n||("get"in n?!t.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,n)}:function(e,t,i,r){r===void 0&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var i in e)i!=="default"&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cluster_1=__importStar(require("cluster")),os_1=require("os"),config_1=__importDefault(require("../config/config")),prometheus_1=require("../lib/monitor/prometheus"),initialize=async()=>{if(config_1.default.isDev){await(0,prometheus_1.initialize)("queue"),require("./job");return}if(await(0,prometheus_1.initialize)("queue",!0),cluster_1.isWorker){require("./job");return}const e=require("../lib/logger").default,t=process.env.QUEUE_WORKERS||(0,os_1.cpus)().length,i=()=>{(0,cluster_1.fork)().on("error",r=>{e.error(r.message,{response:r})})};for(let r=0;r<t;r++)i();cluster_1.default.on("exit",(r,n,u)=>{e.error(`Queue(exit): worker(${r.process.pid}) died with code(${n}) and signal(${u})`),i()})};initialize();