"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.QueueGetter=exports.createQueue=void 0;const bull_1=__importDefault(require("bull")),ioredis_1=__importDefault(require("ioredis")),memoize_one_1=__importDefault(require("memoize-one")),config_1=__importDefault(require("../../config/config")),handler_1=require("../../lib/signal/handler"),getClientRedis=(0,memoize_one_1.default)(()=>new ioredis_1.default(config_1.default.queue.redis.url,{maxRetriesPerRequest:null,enableReadyCheck:!1})),getSubscriberRedis=(0,memoize_one_1.default)(()=>new ioredis_1.default(config_1.default.queue.redis.url,{maxRetriesPerRequest:null,enableReadyCheck:!1})),getDefaultRedis=()=>new ioredis_1.default(config_1.default.queue.redis.url,{maxRetriesPerRequest:null,enableReadyCheck:!1}),createQueue=(e,t={})=>{const r=u=>{switch(u){case"client":return getClientRedis();case"subscriber":return getSubscriberRedis();default:return getDefaultRedis()}};return new bull_1.default(e,{...config_1.default.queue.options,...t,createClient:r})};exports.createQueue=createQueue;class QueueGetter{constructor(t){this.name=t,this.handleSignalClose=async()=>{this.cache&&(await this.cache.close(),this.cache=void 0)},this.getQueue=()=>(this.cache||(this.cache=(0,exports.createQueue)(this.name)),this.cache),(0,handler_1.registerCleanupHandler)(this.handleSignalClose)}async close(){this.cache&&((0,handler_1.removeCleanupHandler)(this.handleSignalClose),await this.cache.close(),this.cache=void 0)}}exports.QueueGetter=QueueGetter;