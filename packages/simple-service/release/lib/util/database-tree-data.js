"use strict";var __importDefault=this&&this.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteTreeItem=exports.createTreeItem=exports.getTreeData=exports.reparent=void 0;const lodash_1=__importDefault(require("lodash")),core_1=require("@sequelize/core"),error_1=require("../error"),reparent=async r=>{const{sourceId:_,targetId:o,transaction:s,position:a}=r,t=r.placeholderLength||3,n=r.Model,i=await n.findOne({attributes:["id","parent_id","sequence_id"],where:{id:_},transaction:s});if(!i)throw new error_1.DataError("No source node.");let u=i.sequence_id.slice(0,-t),l=await n.findAll({attributes:["id","parent_id","sequence_id"],where:{[core_1.Op.and]:[{sequence_id:{[core_1.Op.like]:`${u}%`}},{sequence_id:{[core_1.Op.gte]:i.sequence_id}}]},transaction:s}),c=[],q=[];const g=[];lodash_1.default.forEach(l,e=>{e.sequence_id>i.sequence_id&&!lodash_1.default.startsWith(e.sequence_id,i.sequence_id)&&(e.sequence_id.length===i.sequence_id.length?q.push(e):c.push(e)),lodash_1.default.startsWith(e.sequence_id,i.sequence_id)&&g.push(e)});let f=[];lodash_1.default.forEach(q,e=>{const w=e.sequence_id,I=`${u}${lodash_1.default.padStart(`${parseInt(e.sequence_id.slice(-t),10)-1}`,t,"0")}`;e.sequence_id=I,f.push(e.save({transaction:s})),c=lodash_1.default.filter(c,p=>lodash_1.default.startsWith(p.sequence_id,w)?(p.sequence_id=p.sequence_id.replace(new RegExp(`^${w}`),I),f.push(p.save({transaction:s})),!1):!0)}),await Promise.all(f);const d=await n.findOne({attributes:["id","parent_id","sequence_id"],where:{id:o},transaction:s});if(!d)throw new error_1.DataError("No target node.");a==="child"?l=await n.findAll({attributes:["id","parent_id","sequence_id"],where:{parent_id:d.id},transaction:s}):(u=d.sequence_id.slice(0,-t),l=await n.findAll({attributes:["id","parent_id","sequence_id"],where:{[core_1.Op.and]:[{sequence_id:{[core_1.Op.like]:`${u}%`}},{sequence_id:{[core_1.Op.gte]:d.sequence_id}}]},transaction:s}));const x=lodash_1.default.map(g,"id");l=lodash_1.default.filter(l,e=>!lodash_1.default.includes(x,e.id)),c=[],q=[],f=[];let h,$;if(a==="child"){const e=l.length;h=`${d.sequence_id}${lodash_1.default.padStart(`${e+1}`,t,"0")}`,$=d.id}else a==="above"?(lodash_1.default.forEach(l,e=>{e.sequence_id>=d.sequence_id&&(e.sequence_id.length===d.sequence_id.length?q.push(e):c.push(e))}),h=d.sequence_id):(lodash_1.default.forEach(l,e=>{e.sequence_id>d.sequence_id&&!lodash_1.default.startsWith(e.sequence_id,d.sequence_id)&&(e.sequence_id.length===d.sequence_id.length?q.push(e):c.push(e))}),h=`${u}${lodash_1.default.padStart(`${parseInt(d.sequence_id.slice(-t),10)+1}`,t,"0")}`),$=d.parent_id,lodash_1.default.forEach(q,e=>{const w=e.sequence_id,I=`${u}${lodash_1.default.padStart(`${parseInt(e.sequence_id.slice(-t),10)+1}`,t,"0")}`;e.sequence_id=I,f.push(e.save({transaction:s})),c=lodash_1.default.filter(c,p=>lodash_1.default.startsWith(p.sequence_id,w)?(p.sequence_id=p.sequence_id.replace(new RegExp(`^${w}`),I),f.push(p.save({transaction:s})),!1):!0)});const E=i.sequence_id;return lodash_1.default.forEach(g,e=>{e.id===i.id&&(e.parent_id=$),e.sequence_id=e.sequence_id.replace(new RegExp(`^${E}`),h),f.push(e.save({transaction:s}))}),await Promise.all(f),h};exports.reparent=reparent;const getTreeData=r=>{const _=lodash_1.default.orderBy(r.items,["sequence_id"],"asc"),o=new Map,s=[],a=[];return lodash_1.default.forEach(_,t=>{const n={key:t.id,title:t.name,data:t.data,children:[]};a.push(t.id),t.parent_id===null?s.push(n):o.get(t.parent_id)?.children?.push(n),o.set(t.id,n)}),{keys:a,roots:s}};exports.getTreeData=getTreeData;const createTreeItem=async r=>{const{targetId:_,values:o,position:s,transaction:a,placeholderLength:t=3}=r,n=r.Model,i=await n.findOne({attributes:[[(0,core_1.fn)("max",(0,core_1.col)("sequence_id")),"maxSequenceId"]],where:{parent_id:null},transaction:a});let u="001";if(i?.get("maxSequenceId")){const c=parseInt(i.get("maxSequenceId"))+1;if(c>=Math.pow(10,t))throw new error_1.LogicError("Sequence id reached the limitation.");u=lodash_1.default.padStart(`${c}`,t,"0")}const l=await n.create({...o,parent_id:null,sequence_id:u},{transaction:a});_!==-1&&await(0,exports.reparent)({sourceId:l.id,targetId:_,position:s,Model:n,placeholderLength:t,transaction:a})};exports.createTreeItem=createTreeItem;const deleteTreeItem=async r=>{const{id:_,placeholderLength:o=3,transaction:s}=r,a=r.Model,t=await a.count({where:{parent_id:null},transaction:s});if(t===0)throw new error_1.DataError("No available data to delete.");const n=lodash_1.default.padStart(`${t}`,o,"0"),i=await a.findOne({attributes:["id"],where:{parent_id:null,sequence_id:n},transaction:s});if(!i)throw new error_1.DataError("No available target node.");const u=await(0,exports.reparent)({sourceId:_,targetId:i.id,position:"below",Model:a,placeholderLength:o,transaction:s});return await a.destroy({where:{sequence_id:{[core_1.Op.like]:`${u}%`}},transaction:s}),!0};exports.deleteTreeItem=deleteTreeItem;