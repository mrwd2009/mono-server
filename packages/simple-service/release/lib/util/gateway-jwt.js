"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.verfyToken=exports.createToken=void 0;const jsonwebtoken_1=__importDefault(require("jsonwebtoken")),dayjs_1=__importDefault(require("dayjs")),config_1=__importDefault(require("../../config/config")),common_1=require("./common"),error_1=require("../error"),createToken=async e=>{const s=e.expireHour||config_1.default.jwt.expireHour,r=e.secret||config_1.default.jwt.secret,u=e.issuer||config_1.default.jwt.issuer,n=e.audience||config_1.default.jwt.audience,c=dayjs_1.default.utc().add(s,"hours"),o=await new Promise((i,t)=>{if(!r)throw new error_1.GatewayError("JWT secret is required.");const w=(d,f)=>d?t(d):f?i(f):t(new error_1.GatewayError("Empty jwt token."));jsonwebtoken_1.default.sign({sub:e.id,type:e.type,exp:c.unix()},r,{issuer:u,audience:n},w)});return await e.UserToken.create({user_id:e.id,signature:(0,common_1.getJwtTokenSignature)(o),token:o,status:"enabled",expired_at:c.format()},{transaction:e.transaction})};exports.createToken=createToken;const verfyToken=async e=>{const s=e.secret||config_1.default.jwt.secret,r=e.issuer||config_1.default.jwt.issuer,u=e.audience||config_1.default.jwt.audience,n=await new Promise((o,a)=>{jsonwebtoken_1.default.verify(e.token,s,{issuer:r,audience:u},(i,t)=>{if(i)return a(i);t?o({id:t.sub,type:t.type}):a(new error_1.GatewayError("Empty jwt token."))})});if(n.type!=="user")throw new error_1.DataError("Invalid token.");if(!await e.UserToken.findOne({attributes:["id"],where:{user_id:n.id,signature:(0,common_1.getJwtTokenSignature)(e.token),status:"enabled"},transaction:e.transaction}))throw new error_1.DataError("Invalid token.");return n.id};exports.verfyToken=verfyToken;