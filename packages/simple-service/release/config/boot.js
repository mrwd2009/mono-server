"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const http_1=__importDefault(require("http")),initializer_1=__importDefault(require("./initializer")),middleware_1=__importDefault(require("./middleware")),dispatch_1=__importDefault(require("./dispatch")),util_1=require("../lib/util"),config_1=__importDefault(require("./config")),logger_1=__importDefault(require("../lib/logger")),handler_1=require("../lib/signal/handler"),catchUnhandledError=async e=>{e.silent=!0,e.on("error",(t,r)=>{logger_1.default.error(t.message,{response:t,user:r?.state.user?.email||"ananymity"})})},trustProxy=async e=>{e.proxy=!0},setCookieKeys=async e=>{e.keys=config_1.default.cookie.keys},listen=async(e,t)=>{const r=new Promise((s,a)=>{const o=http_1.default.createServer(e.callback()).listen(t,()=>{config_1.default.isDev&&(console.log("\x1B[38;5;28m--------------------- API Serivce ---------------------\x1B[0m"),console.log(`The http endpoints are as following.
`),console.log(`\x1B[30;1mLocal:\x1B[0m            http://localhost:\x1B[30;1m${t}\x1B[0m/`),console.log(`\x1B[30;1mOn Your Network:\x1B[0m  http://${util_1.ip.getLocalIPs()[0]}:\x1B[30;1m${t}\x1B[0m/`),console.log(`
`)),s(!0)});(0,handler_1.registerCleanupHandler)(async()=>{await new Promise((i,l)=>{o.close(n=>n?l(n):i(!0))})}),o.on("error",i=>{a(i),i&&console.error(i)})});(0,handler_1.registerInitPromise)(r),await r},boot=async(e,t)=>{await(0,initializer_1.default)(),await(0,middleware_1.default)(e),await(0,dispatch_1.default)(e),await catchUnhandledError(e),await trustProxy(e),await setCookieKeys(e),await listen(e,t)};exports.default=boot;