"use strict";var __importDefault=this&&this.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initialize=void 0;const rate_limiter_flexible_1=require("rate-limiter-flexible"),uuid_1=require("uuid"),redis_1=require("../../lib/redis"),config_1=__importDefault(require("../config")),{rateLimiter:opts}=config_1.default,rateLimiter=()=>{let i,s;config_1.default.isDev?(i=new rate_limiter_flexible_1.RateLimiterMemory({points:opts.byIP.points,duration:opts.byIP.duration}),s=new rate_limiter_flexible_1.RateLimiterMemory({points:opts.byID.points,duration:opts.byID.duration})):(i=new rate_limiter_flexible_1.RateLimiterRedis({storeClient:redis_1.mainRedis.getClient(),keyPrefix:`${opts.keyPrefix}-ip`,points:opts.byIP.points,duration:opts.byIP.duration}),s=new rate_limiter_flexible_1.RateLimiterRedis({storeClient:redis_1.mainRedis.getClient(),keyPrefix:`${opts.keyPrefix}-id`,points:opts.byID.points,duration:opts.byID.duration}));const u=e=>e?s:i,n=(e,t)=>{"msBeforeNext"in e&&(t.set("X-RateLimit-Limit",`${e.remainingPoints+e.consumedPoints}`),t.set("X-RateLimit-Remaining",`${e.remainingPoints}`),t.set("X-RateLimit-Reset",`${Math.ceil(new Date().getTime()/1e3+e.msBeforeNext/1e3)}`))};return async(e,t)=>{try{let r=e.ip;const o=e.cookies.get(opts.cookieKey,{signed:!0});let a=!1;o?(r=o,a=!0):e.cookies.set(opts.cookieKey,(0,uuid_1.v4)(),{httpOnly:!0,maxAge:opts.cookieExpiredDay*24*3600*1e3,signed:!0});const l=await u(a).consume(r);n(l,e)}catch(r){n(r,e),e.status=429,e.body={meta:{code:429,message:"Too many requests, please try again later."}};return}await t()}},initialize=async i=>{await i.use(rateLimiter())};exports.initialize=initialize,exports.default=exports.initialize;