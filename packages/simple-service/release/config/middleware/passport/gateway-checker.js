"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,i){i===void 0&&(i=t);var n=Object.getOwnPropertyDescriptor(r,t);(!n||("get"in n?!r.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,i,n)}:function(e,r,t,i){i===void 0&&(i=t),e[i]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var t in e)t!=="default"&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const dayjs_1=__importDefault(require("dayjs")),app_1=__importDefault(require("../../model/app")),error_1=require("../../../lib/error"),util_1=__importStar(require("../../../lib/util")),{gateway:{models:{User,UserToken},sequelize}}=app_1.default,config_1=__importDefault(require("../../config")),checker_1=require("./checker"),extendSession=async e=>await sequelize.transaction(async r=>{const t=await UserToken.findOne({attributes:["id","user_id","child_token_id"],where:{id:e},transaction:r,lock:r.LOCK.UPDATE});if(!t)throw new error_1.AuthError("Invalid token.");if(t.child_token_id){const n=await UserToken.findOne({attributes:["id","token"],where:{id:t.child_token_id},transaction:r});if(!n)throw new error_1.AuthError("Invalid token.");return n.token}const i=await util_1.gatewayJwt.createToken({id:t.user_id,type:"user",transaction:r,UserToken});return i.parent_token_id=t.id,t.child_token_id=i.id,await Promise.all([t.save({transaction:r}),i.save({transaction:r})]),i.token}),checker=async(e,r)=>{if(e?.type==="user"){const t=await User.findOne({attributes:["id","email"],where:{id:e.sub},include:{model:UserToken,attributes:["id","expired_at"],where:{user_id:e.sub,signature:util_1.default.getJwtTokenSignature(r),status:"enabled"}}});if(!t||!t.UserTokens?.length)throw new error_1.AuthError("Invalid or expired token.");const i=t.UserTokens[0];return{passed:!0,entity:{id:t.id,type:"user",email:t.email},afterChecker:async n=>{if(!(0,checker_1.canExtendSession)(n))return;const u=(0,dayjs_1.default)(i.expired_at).subtract(config_1.default.auth.session.restHour,"hour");if((0,dayjs_1.default)().isAfter(u)){const s=await extendSession(i.id);n.cookies.set(config_1.default.jwt.cookieKey,s,{httpOnly:!0,maxAge:config_1.default.jwt.expireHour*3600*1e3,signed:!0})}}}}return{passed:!1}};(0,checker_1.registerChecker)(checker),exports.default=checker;