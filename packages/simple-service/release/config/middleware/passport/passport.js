"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initialize=exports.jwtAuth=void 0;const koa_passport_1=__importDefault(require("koa-passport")),cookie_1=__importDefault(require("cookie")),passport_jwt_1=require("passport-jwt"),config_1=__importDefault(require("../../config")),error_1=require("../../../lib/error");require("./gateway-checker");const checker_1=require("./checker"),getToken=e=>cookie_1.default.parse(e.headers.cookie||"")[config_1.default.jwt.cookieKey],options={jwtFromRequest:passport_jwt_1.ExtractJwt.fromExtractors([getToken]),secretOrKey:config_1.default.jwt.secret,issuer:config_1.default.jwt.issuer,audience:config_1.default.jwt.audience,passReqToCallback:!0},getUser=(e,o,t)=>{const s=getToken(e);if(!s)return t(new error_1.AuthError("Unknown token."));(0,checker_1.executeCheckers)(o,s).then(r=>{r?.passed&&r?.entity?(e.ctx._passportAfterChecker=r.afterChecker,t(null,r.entity)):t(new error_1.AuthError("Unknown token."))}).catch(()=>{t(new error_1.AuthError("Unknown token."))})};koa_passport_1.default.use(new passport_jwt_1.Strategy(options,getUser)),exports.jwtAuth=koa_passport_1.default.authenticate("jwt",{session:!1});const initialize=async e=>{await e.use(koa_passport_1.default.initialize()),await e.use(checker_1.checkerMiddleware)};exports.initialize=initialize,exports.default=exports.initialize;