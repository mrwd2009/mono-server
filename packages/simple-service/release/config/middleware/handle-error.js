"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,a,t,r){r===void 0&&(r=t);var s=Object.getOwnPropertyDescriptor(a,t);(!s||("get"in s?!a.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return a[t]}}),Object.defineProperty(e,r,s)}:function(e,a,t,r){r===void 0&&(r=t),e[r]=a[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,a){Object.defineProperty(e,"default",{enumerable:!0,value:a})}:function(e,a){e.default=a}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var a={};if(e!=null)for(var t in e)t!=="default"&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(a,e,t);return __setModuleDefault(a,e),a},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initialize=exports.handleError=void 0;const lodash_1=__importDefault(require("lodash")),uuid_1=require("uuid"),config_1=__importDefault(require("../../config")),lib=__importStar(require("../../lib")),logger_1=__importDefault(require("../../lib/logger")),{error:{GatewayError}}=lib,handleError=async(e,a)=>{try{await a()}catch(t){const r=t,s=e.state.requestId||(0,uuid_1.v4)();switch(config_1.default.isDev?(config_1.default.traceKnownErrorInDev||!(r instanceof GatewayError))&&(console.error(`\x1B[38;2;255;77;79mError occurred at request: ${e.method} ${e.originalUrl}\x1B[0m`),lodash_1.default.isEmpty(e.query)||(console.error("\x1B[38;2;0;204;204mQuery Parameters:\x1B[0m"),console.error(`\x1B[38;2;82;196;26m${JSON.stringify(e.query,null,2)}\x1B[0m`)),lodash_1.default.isEmpty(e.request.body)||(console.error("\x1B[38;2;0;204;204mPost Body:\x1B[0m"),console.error(`\x1B[38;2;82;196;26m${JSON.stringify(e.request.body,null,2)}\x1B[0m`)),r.httpResponse?.data&&(console.error("\x1B[38;2;0;204;204mResponse:\x1B[0m"),console.error(`\x1B[38;2;82;196;26m${JSON.stringify(r.httpResponse.data,null,2)}\x1B[0m`)),console.error(`\x1B[38;2;255;77;79m${r.stack}\x1B[0m
`)):(lodash_1.default.isEmpty(e.query)||(r.query=e.query),lodash_1.default.isEmpty(e.request.body)||(r.body=e.request.body),logger_1.default.error(r.message,{response:r,trackId:s,user:e.state.user?.email||"ananymity"})),r.code){case"AuthError":{e.status=401,e.body={meta:{code:401,trackId:s,message:r.message},data:null};break}case"BackendError":{e.status=500,e.body={meta:{code:500,trackId:s,message:config_1.default.isDev&&r.message||r.publicMessage},data:null};break}case"DataError":case"GatewayError":case"LogicError":case"ParamError":{e.status=500,e.body={meta:{code:500,trackId:s,message:r.message},data:null};break}case"ForbiddenError":{e.status=403,e.body={meta:{code:403,trackId:s,message:r.message},data:null};break}default:e.status=501,e.body={meta:{code:501,trackId:s,message:config_1.default.isDev?r.message:"Internal Error"},data:null}}}};exports.handleError=handleError;const initialize=async e=>{await e.use(exports.handleError)};exports.initialize=initialize,exports.default=exports.initialize;