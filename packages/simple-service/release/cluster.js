"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,i,n){n===void 0&&(n=i);var t=Object.getOwnPropertyDescriptor(r,i);(!t||("get"in t?!r.__esModule:t.writable||t.configurable))&&(t={enumerable:!0,get:function(){return r[i]}}),Object.defineProperty(e,n,t)}:function(e,r,i,n){n===void 0&&(n=i),e[n]=r[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var i in e)i!=="default"&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(r,e,i);return __setModuleDefault(r,e),r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),require("dotenv/config");const cluster_1=__importStar(require("cluster")),os_1=require("os"),config_1=__importDefault(require("./config/config")),application_1=__importDefault(require("./application")),prometheus_1=require("./lib/monitor/prometheus"),handler_1=require("./lib/signal/handler"),{logger:{ipc}}=config_1.default,initialize=async()=>{if(await(0,prometheus_1.initialize)("cluster",!0),cluster_1.isWorker){await new application_1.default().initialize(!0);return}let e=null;ipc.enabled||(e=require("./lib/logger/primary").default);const r=process.env.CLUSTER_WORKERS||(0,os_1.cpus)().length,i=()=>{(0,cluster_1.fork)().on("error",t=>{e?.error(t.message,{response:t}),console.error(t.stack)})};for(let t=0;t<r;t++)i();let n=!1;cluster_1.default.on("exit",(t,u,a)=>{const o=`API(exit): worker(${t.process.pid}) died with code(${u}) and signal(${a})`;e?.error(o),console.error(o),!n&&i()}),(0,handler_1.registerCleanupHandler)(async()=>{await new Promise(t=>{n=!0,t(!0)})})};initialize();